#!/bin/bash
# Ralph commit-msg hook
# Automatically updates CHANGELOG.md based on conventional commit messages
#
# Install: cp hooks/commit-msg .git/hooks/commit-msg && chmod +x .git/hooks/commit-msg

COMMIT_MSG_FILE="$1"
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

# Get the repo root
REPO_ROOT=$(git rev-parse --show-toplevel)
CHANGELOG="$REPO_ROOT/CHANGELOG.md"

# Skip if this is a merge commit, amend, or release commit
if echo "$COMMIT_MSG" | grep -qE -- "^Merge |^Release v|^\[skip changelog\]"; then
  exit 0
fi

# Skip if CHANGELOG.md doesn't exist
if [ ! -f "$CHANGELOG" ]; then
  exit 0
fi

# Parse conventional commit type and extract the message
# Format: type(scope): description  OR  type: description
if echo "$COMMIT_MSG" | grep -qE -- "^(feat|fix|docs|style|refactor|perf|test|chore|build|ci)(\(.+\))?!?:"; then
  # Extract type (with optional ! for breaking)
  TYPE=$(echo "$COMMIT_MSG" | sed -E 's/^([a-z]+)(\(.+\))?(!)?:.*/\1\3/')

  # Extract the first line (summary)
  SUMMARY=$(echo "$COMMIT_MSG" | head -1 | sed -E 's/^[a-z]+(\(.+\))?!?:\s*//')

  # Map commit type to changelog section
  case "$TYPE" in
    feat|feat!)
      SECTION="Added"
      ;;
    fix|fix!)
      SECTION="Fixed"
      ;;
    docs)
      SECTION="Documentation"
      ;;
    perf)
      SECTION="Performance"
      ;;
    refactor)
      SECTION="Changed"
      ;;
    chore|build|ci|style|test)
      # Skip these types - they don't need changelog entries
      exit 0
      ;;
    *)
      SECTION="Changed"
      ;;
  esac

  # Check if there's a breaking change
  if echo "$COMMIT_MSG" | grep -qE -- "^BREAKING CHANGE:|^[a-z]+(\(.+\))?!:"; then
    SECTION="Breaking Changes"
  fi

  # Check if this entry already exists (avoid duplicates on amend)
  if grep -qF -- "- $SUMMARY" "$CHANGELOG" 2>/dev/null; then
    exit 0
  fi

  # Create a temp file for the new changelog
  TEMP_CHANGELOG=$(mktemp)

  # Find [Unreleased] section and add entry under appropriate subsection
  awk -v section="$SECTION" -v summary="$SUMMARY" '
    BEGIN {
      in_unreleased=0
      in_target_section=0
      added=0
      buffer=""
    }

    # Found [Unreleased] header
    /^## \[Unreleased\]/ {
      print
      in_unreleased=1
      next
    }

    # Found next version header - end of unreleased section
    in_unreleased && /^## \[/ {
      # If we havent added yet, add new section before this line
      if (!added) {
        print ""
        print "### " section
        print "- " summary
        added=1
      }
      in_unreleased=0
      print
      next
    }

    # In unreleased section, found our target section header
    in_unreleased && $0 == "### " section {
      print
      print "- " summary
      added=1
      in_target_section=1
      next
    }

    # In unreleased section, found a different section header
    in_unreleased && /^### / {
      in_target_section=0
      print
      next
    }

    { print }

    END {
      # If file ended while still in unreleased and we never added
      if (in_unreleased && !added) {
        print ""
        print "### " section
        print "- " summary
      }
    }
  ' "$CHANGELOG" > "$TEMP_CHANGELOG"

  # Verify entry was added
  if ! grep -qF -- "- $SUMMARY" "$TEMP_CHANGELOG"; then
    echo "Warning: Failed to add changelog entry" >&2
    rm -f "$TEMP_CHANGELOG"
    exit 0
  fi

  # Replace original changelog
  mv "$TEMP_CHANGELOG" "$CHANGELOG"

  # Stage the changelog update
  git add "$CHANGELOG"

fi

exit 0
